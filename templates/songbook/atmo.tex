% Copyright (C) 2014 The Patacrep Team
% Copyright (C) 2009-2010 Romain Goffe, Alexandre Dupas
% Copyright (C) 2008 Kevin W. Hamlen
%
% This program is free software; you can redistribute it and/or
% modify it under the terms of the GNU General Public License
% as published by the Free Software Foundation; either version 2
% of the License, or (at your option) any later version.
%
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with this program; if not, write to the Free Software
% Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
% MA  02110-1301, USA.

(* variables *)
schema:
  type: //rec
  optional:
    chordfont: //str
    chordcolor: //str
    chordsize: //str
    versefont: //str
    chorusfont: //str
    geometry: //str
    column_adjustment:
      type: //any
      of:
        - type: //str
          value: "only_one"
        - type: //str
          value: "one_more"
        - type: //str
          value: "two"
        - type: //str
          value: "none"
default:
  en:
    chordfont: "i"
    chordcolor: "000000"
    chordsize: "n"
    versefont: ""
    chorusfont: "i"
    geometry: "a4paper"
    column_adjustment: none
description:
  en:
    chordfont: "Chord font (i, b, n)"
    chordcolor: "Chord color, hexadecimal notation"
    chordsize: "Chord font size"
    versefont: "Verse font (i, b, n)"
    chorusfont: "Chorus font (i, b, n)"
    geometry: "Paper geometry (size, margin, orientation...), as options of the LaTeX geometry package."
    column_adjustment: "Column adjsutment."
  fr:
    chordfont: "Police des accords"
    chordcolor: "Couleur des accords en notation hexadécimale"
    chordsize: "Taille de la police pour les accords"
    versefont: "Police des couplets"
    chorusfont: "Police des refrains"
    geometry: "Format du papier (taille, marges, orientation...), avec le même format que les options du paquet LaTeX geometry."
    column_adjustment: "Ajustement des colonnes."


(* endvariables *)

% begin document
(* extends "patacrep.tex" *)

(* block preambule *)
(*- set template_var = _template["atmo.tex"] -*)
\songpos{0}
%% CUSTOM
\renewcommand{\songmark}{\markboth{\thesongnum}{\thesongnum}}
%\usepackage{tabularx}
%\usepackage{tabu}
%\usepackage{multirow}
%\usepackage{array}
%\usepackage{environ}
%\usepackage{collect}
\newcounter{lineno}

%%%
% IT'S WORKING : AVEC LES ACCORDS !! SANS ARGUMENT !!
%%%
\makeatletter
\def\marker{\end{bis}}
{\obeylines
\gdef\getlines#1
{\def\text{#1}%
	\ifx\text\marker \let\next\text \else
	\line{#1} \let\next\getlines\fi \next}}
\newlength{\bislyrics}

\newenvironment{bis}{
\setcounter{lineno}{0}
\def\tabcolsep{0pt}%
\setlength\arrayrulewidth{0.5pt}%
\setbox0=\hbox{\footnotesize({\it\bfseries bis})}
\setlength{\bislyrics}{\dimexpr(\hsize-\wd0-\arrayrulewidth-\tabcolsep-4pt)\relax}
\renewcommand{\line}[1]{\small{\bf{##1}}}%
\setbox2=\hbox{~}
\setbox1=\vbox{\copy2\hspace{-1.5\wd2}\\}
\copy1
\vspace{-0.72\ht1}
\begin{tabular}{p{\bislyrics}@{\hspace{4pt}}|}%
\begingroup\obeylines\getlines}%
{\endgroup%
\end{tabular}%
\begin{tabular}{@{\hspace{1pt}}l}%
	\copy0
\end{tabular}
\\[0.1\ht1]
%\vspace{-0.72\ht1}
}
\makeatother
%%%


%%%
% IT'S WORKING !!! (sans les accords pour l'instant)
%%%
%\makeatletter
%\def\activateCtrlChars{%
%	\catcode`\^^M=\active
%	\begingroup\lccode`~=`\^^M\lowercase{\endgroup\bf\small\def~}{\egroup\\\bgroup}%
%}
%\begingroup																															
%\obeylines
%\gdef\gobbleLineBreak{\@ifnextchar^^M{\@gobble}{}}%
%\endgroup%
%\makeatother
%\newlength{\bislyrics}
%\newenvironment{newbis}[1][]{%
%	\def\tabcolsep{3pt}%
%	\setbox0=\hbox{\small\it\bfseries(bis)}
%	\setlength{\bislyrics}{\dimexpr(\hsize-\wd0-\arrayrulewidth-\tabcolsep+10pt)\relax}
%	\if\detokenize{f}\detokenize{#1}\relax%
%	~\vspace{-0.72\baselineskip}\\\fi%
%	\activateCtrlChars%
%		\tabularx{\bislyrics}{@{}X|}\gobbleLineBreak\bgroup%
%	}
%{\egroup\endtabularx%
%	\def\tabcolsep{2pt}%
%\begin{tabular}{l}
%\copy0
%\end{tabular}}
%%%

\newcommand{\linerep}[2]{\small\textbf{#1}\hfill{\footnotesize(x#2)}}
%%

%! Font management
\makeatletter
\renewcommand{\chorusfont}{%
   (* for letter in template_var.chorusfont *)
   (* if letter=="i" *)   \it %
   (* elif letter=='b' *)   \bf %
   (* elif letter=='n' *)   \normalfont %
   (* endif *)
   (* endfor *)
}

\def\@chordfont{%

   (* if template_var.chordfont=="i" *)  \it %
   (* elif template_var.chordfont=='b' *)   \bf %
   (* elif template_var.chordfont=='bi' *)   \it \bfseries %
   (* elif template_var.chordfont=='n' *)   \normalfont %
   (* endif *)

   
   (* for size in template_var.chordsize *)
   (* if size=='s' *) \small %
   (* elif size=='f' *) \footnotesize %
   (* elif size=='r' *) \scriptsize %
   (* elif size=='t' *) \tiny %
   (* endif *)
   (* endfor *)
}
\definecolor{ChordColor}{HTML}{(( template_var.chordcolor ))}
\renewcommand{\printchord}[1]{\@chordfont\textcolor{ChordColor}{#1}}

\renewcommand{\lyricfont}{%
   (* for letter in template_var.versefont *)
   (* if letter=="i" *)   \it %
   (* elif letter=='b' *)   \bf %
   (* elif letter=='n' *)   \normalfont %
   (* endif *)
   (* endfor *)
}
\makeatother
%! End of font management

\geometry{
 ((template_var.geometry))
}

%! Temporary hack for columns management
\let\OldSongColumns=\songcolumns
\def\songcolumns#1{%
(* if template_var.column_adjustment=="only_one" *)
    \OldSongColumns{1}
(* elif template_var.column_adjustment=="two" *)
    \count0=1\relax\advance\count0 by 1\relax%
    \OldSongColumns{\count0}
(* elif template_var.column_adjustment=="one_more" *)
    \count0=#1\relax\advance\count0 by 1\relax%
    \OldSongColumns{\count0}
(* else *)
    \OldSongColumns{#1}
(* endif *)
}
%! End of columns management
(* endblock *)

(* block preface *)
(* endblock *)
% end document